#!/usr/bin/env python3
from flask import Flask
import subprocess
import base64
import os
app = Flask(__name__)
DATADIR = os.environ.get('GRAPHVIZ_DATADIR', './')

favicon = "<link id=\"favicon\" rel=\"shortcut icon\" href=\"data:image/vnd.microsoft.icon;base64,AAABAAEAGBgAAAEAIACICQAAFgAAACgAAAAYAAAAMAAAAAEAIAAAAAAAAAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAA8AAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA8AAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAACgAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAJ8AAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAQAAAAzwAAAP8AAAD/AAAAzwAAAHAAAAD/AAAA/wAAAP8AAAD/AAAAzwAAABAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAMAAAAO8AAADvAAAAMAAAAAAAAACgAAAA/wAAAP8AAADvAAAAMAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAGAAAABgAAAAAAAAAAAAAAAQAAAAzwAAAP8AAABgAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAI8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAO8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAA7wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA7wAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wDgAAcA4AAHAOf/5wDn/+cA5AAnAOQAJwDmEGcA5zDnAOf55wDn/+cA5//nAOf/5wDn/+cA5//nAOf/5wDn/+cA4AAHAOAABwD///8A////AP///wA=\">"

@app.route("/")
def welcome():
    return f"<!doctype html><html><head>{favicon}<title>Graphviz</title></head><body><h1>Graphviz web preview</h1><h3>Usage</h3><p><code>http(s)://host/ENGINE/TYPE/FILE</code></p><ul><li>Engine is one of dot, neato, twopi, circo, fdp, sfdp, patchwork, or osage.</li><li>Type is generally png or svg for best results. See the <a href=\"https://graphviz.org/docs/outputs/\">docs</a> for more formats.</li><li>File is the path to your file (current directory or lower).</li></body></html>"

@app.errorhandler(404)
def errorhandler(e):
    return f"<!doctype html><html><head>{favicon}<title>Graphviz</title></head><body><h1>Graphviz web preview</h1><h3>Usage</h3><p><code>http(s)://host/ENGINE/TYPE/FILE</code></p><ul><li>Engine is one of dot, neato, twopi, circo, fdp, sfdp, patchwork, or osage.</li><li>Type is generally png or svg for best results. See the <a href=\"https://graphviz.org/docs/outputs/\">docs</a> for more formats.</li><li>File is the path to your file (current directory or lower).</li></body></html>"

@app.route("/<string:engine>/<string:imgtype>/<path:name>")
def getMemberPath(engine, imgtype, name):
    if engine not in ["dot", "neato", "twopi", "circo", "fdp", "sfdp", "patchwork", "osage"]:
        return f"<!doctype html><html><head>{favicon}<title>Graphviz</title><meta http-equiv=\"cache-control\" content=\"no-cache\" /></head><body>Provide a valid engine (one of dot, neato, twopi, circo, fdp, sfdp, patchwork, or osage).</body></html>", 400
    dot = subprocess.run([engine, "-T" + imgtype, name], capture_output=True, cwd=DATADIR)
    errortext = ""
    if dot.stderr:
        errortext = '<p>' + dot.stderr.decode('utf-8') + '</p>'
    return f"<!doctype html><html><head>{favicon}<title>Graphviz</title><meta http-equiv=\"refresh\" content=\"120\"/><meta http-equiv=\"cache-control\" content=\"no-cache\" /></head><body><img style=\"height: 100%; width: 100%; object-fit: contain\" src=\"data:image/{type if not type == 'svg' else 'svg+xml'};base64,{base64.b64encode(dot.stdout).decode('ascii')}\"/>{errortext}</body></html>"

if __name__ == "__main__":
    from waitress import serve
    import logging
    logger = logging.getLogger('waitress')
    logger.setLevel(logging.INFO) # TODO: add request logging
    serve(app, listen=os.environ.get('GRAPHVIZ_HOST', '*')+":"+os.environ.get('GRAPHVIZ_PORT', '8080'))
